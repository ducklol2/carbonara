<!DOCTYPE html>
<meta charset="UTF-8">

<head>
  <title>üçù</title>
  <style>
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <h3>groceries</h3>
  <p><input type="text" autofocus></p>
  <div id="list">
  </div>

  <script type="module">
    const list = document.querySelector('#list');
    const input = document.querySelector('input[type="text"]');

    input.onkeydown = event => {
      if (event.key == 'Enter') {
        const item = event.target.value;
        event.target.value = '';
        send(item);
      }
    };

    async function send(item) {
      const res = await fetch('/add', {
        method: "POST",
        "Content-type": "application/json",
        body: JSON.stringify({ item })
      });

      if (!res.ok) {
        console.error('Post failed:', res);
        return;
      }

      const data = await res.json();
      if (!data.items) {
        console.error('expected items:', data);
        return;
      }
      render(data.items);
    }

    function render(items) {
      list.replaceChildren();
      for (let i = 0; i < items.length; i++) {
        const div = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        const checkboxId = `item${i}`;
        checkbox.id = checkboxId;
        checkbox.checked = items[i].checked;
        checkbox.onchange = event => {
          check(i, event.target.checked);
        };
        div.append(checkbox);
        const label = document.createElement('label');
        label.textContent = items[i].text;
        label.htmlFor = checkboxId;
        div.append(label);
        list.append(div);
      }
    }

    async function check(itemIndex, checked) {
      const res = await fetch('/check', {
        method: "POST",
        "Content-type": "application/json",
        body: JSON.stringify({ itemIndex, checked })
      });

      if (!res.ok) {
        console.error('/check post failed:', res);
        return;
      }

      const data = await res.json();
      if (!data.items) {
        console.error('expected items:', data);
        return;
      }
      render(data.items);
    }

    async function fetchList() {
      const res = await fetch('/list');
      if (!res.ok) {
        console.error('Post failed:', res);
        return;
      }

      const data = await res.json();
      if (!data.items) {
        console.error('expected items:', data);
        return;
      }
      render(data.items);
    }
    fetchList();
  </script>
</body>

</html>